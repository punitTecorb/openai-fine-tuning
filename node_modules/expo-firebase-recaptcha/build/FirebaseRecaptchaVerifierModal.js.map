{"version":3,"file":"FirebaseRecaptchaVerifierModal.js","sourceRoot":"","sources":["../src/FirebaseRecaptchaVerifierModal.tsx"],"names":[],"mappings":"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","sourcesContent":["import { CodedError } from '@unimodules/core';\nimport * as React from 'react';\nimport {\n  StyleSheet,\n  Button,\n  View,\n  SafeAreaView,\n  Text,\n  Modal,\n  ActivityIndicator,\n} from 'react-native';\n\nimport FirebaseRecaptcha from './FirebaseRecaptcha';\nimport { FirebaseAuthApplicationVerifier } from './FirebaseRecaptcha.types';\n\ninterface Props\n  extends Omit<\n    React.ComponentProps<typeof FirebaseRecaptcha>,\n    'onVerify' | 'invisible' | 'verify' | 'onVerify' | 'onLoad' | 'onError' | 'onFullChallenge'\n  > {\n  title?: string;\n  cancelLabel?: string;\n  attemptInvisibleVerification?: boolean;\n}\ninterface State {\n  visible: boolean;\n  visibleLoaded: boolean;\n  invisibleLoaded: boolean;\n  invisibleVerify: boolean;\n  invisibleKey: number;\n  resolve?: (token: string) => void;\n  reject?: (error: Error) => void;\n}\n\nexport default class FirebaseRecaptchaVerifierModal extends React.Component<Props, State>\n  implements FirebaseAuthApplicationVerifier {\n  static defaultProps = {\n    title: 'reCAPTCHA',\n    cancelLabel: 'Cancel',\n  };\n\n  state: State = {\n    visible: false,\n    visibleLoaded: false,\n    invisibleLoaded: false,\n    invisibleVerify: false,\n    invisibleKey: 1,\n    resolve: undefined,\n    reject: undefined,\n  };\n\n  static getDerivedStateFromProps(props: Props, state: State) {\n    if (!props.attemptInvisibleVerification && state.invisibleLoaded) {\n      return {\n        invisibleLoaded: false,\n        invisibleVerify: false,\n      };\n    }\n    return null;\n  }\n\n  get type(): string {\n    return 'recaptcha';\n  }\n\n  async verify(): Promise<string> {\n    return new Promise((resolve, reject) => {\n      if (this.props.attemptInvisibleVerification) {\n        this.setState({\n          invisibleVerify: true,\n          resolve,\n          reject,\n        });\n      } else {\n        this.setState({\n          visible: true,\n          visibleLoaded: false,\n          resolve,\n          reject,\n        });\n      }\n    });\n  }\n\n  private onVisibleLoad = () => {\n    this.setState({\n      visibleLoaded: true,\n    });\n  };\n\n  private onInvisibleLoad = () => {\n    this.setState({\n      invisibleLoaded: true,\n    });\n  };\n\n  private onFullChallenge = async () => {\n    this.setState({\n      invisibleVerify: false,\n      visible: true,\n    });\n  };\n\n  private onError = () => {\n    const { reject } = this.state;\n    if (reject) {\n      reject(new CodedError('ERR_FIREBASE_RECAPTCHA_ERROR', 'Failed to load reCAPTCHA'));\n    }\n    this.setState({\n      visible: false,\n      invisibleVerify: false,\n    });\n  };\n\n  private onVerify = (token: string) => {\n    const { resolve } = this.state;\n    if (resolve) {\n      resolve(token);\n    }\n    this.setState(state => ({\n      visible: false,\n      invisibleVerify: false,\n      invisibleLoaded: false,\n      invisibleKey: state.invisibleKey + 1,\n    }));\n  };\n\n  cancel = () => {\n    const { reject } = this.state;\n    if (reject) {\n      reject(new CodedError('ERR_FIREBASE_RECAPTCHA_CANCEL', 'Cancelled by user'));\n    }\n    this.setState({\n      visible: false,\n    });\n  };\n\n  onDismiss = () => {\n    // onDismiss should be called when the user dismisses the\n    // modal using a swipe gesture. Due to a bug in RN this\n    // unfortunately doesn't work :/\n    //https://github.com/facebook/react-native/issues/26892\n    if (this.state.visible) {\n      this.cancel();\n    }\n  };\n\n  render() {\n    const { title, cancelLabel, attemptInvisibleVerification, ...otherProps } = this.props;\n    const { visible, visibleLoaded, invisibleLoaded, invisibleVerify, invisibleKey } = this.state;\n    return (\n      <View style={styles.container}>\n        {attemptInvisibleVerification && (\n          <FirebaseRecaptcha\n            {...otherProps}\n            key={`invisible${invisibleKey}`}\n            style={styles.invisible}\n            onLoad={this.onInvisibleLoad}\n            onError={this.onError}\n            onVerify={this.onVerify}\n            onFullChallenge={this.onFullChallenge}\n            invisible\n            verify={invisibleLoaded && invisibleVerify}\n          />\n        )}\n        <Modal\n          visible={visible}\n          animationType=\"slide\"\n          presentationStyle=\"pageSheet\"\n          onRequestClose={this.cancel}\n          onDismiss={this.onDismiss}>\n          <SafeAreaView style={styles.modalContainer}>\n            <View style={styles.header}>\n              <Text style={styles.title}>{title}</Text>\n              <View style={styles.cancel}>\n                <Button\n                  title={cancelLabel || FirebaseRecaptchaVerifierModal.defaultProps.cancelLabel}\n                  onPress={this.cancel}\n                />\n              </View>\n            </View>\n            <View style={styles.content}>\n              <FirebaseRecaptcha\n                {...otherProps}\n                style={styles.content}\n                onLoad={this.onVisibleLoad}\n                onError={this.onError}\n                onVerify={this.onVerify}\n              />\n              {!visibleLoaded ? (\n                <View style={styles.loader}>\n                  <ActivityIndicator size=\"large\" />\n                </View>\n              ) : (\n                undefined\n              )}\n            </View>\n          </SafeAreaView>\n        </Modal>\n      </View>\n    );\n  }\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    width: 0,\n    height: 0,\n  },\n  invisible: {\n    width: 300,\n    height: 300,\n  },\n  modalContainer: {\n    flex: 1,\n  },\n  header: {\n    backgroundColor: '#FBFBFB',\n    height: 44,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    borderBottomColor: '#CECECE',\n    borderBottomWidth: StyleSheet.hairlineWidth,\n  },\n  cancel: {\n    position: 'absolute',\n    left: 8,\n    justifyContent: 'center',\n  },\n  title: {\n    fontWeight: 'bold',\n  },\n  content: {\n    flex: 1,\n  },\n  loader: {\n    ...StyleSheet.absoluteFillObject,\n    paddingTop: 20,\n    justifyContent: 'flex-start',\n    alignItems: 'center',\n  },\n});\n"]}